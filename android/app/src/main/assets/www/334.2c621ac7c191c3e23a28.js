"use strict";(self.webpackChunksosgame=self.webpackChunksosgame||[]).push([[334],{401(e,n,t){t.d(n,{A:()=>o});var r=t(130);function o(e,n,t){if(!t)throw new Error("No signaling");const o=(0,r.A)(["close","disconnect","error","join","gameinit","reconnect"]),i=o.on;let a=null;function s(e){n.log("register1"),a=e}const c=(e,r,o)=>(n.log("broad send",e,r),t.send(e,r,"all",o)),l=(e,n,r)=>t.send(e,n,r);return{connect:async function(){return n.log("bind signal"),t.on("message",t=>{if(n.log("Received message",t),t.from!==e)if(t.to===e||"all"===t.to){if(!(t.ignore&&Array.isArray(t.ignore)&&t.ignore.includes(e)))return o.hasAction(t.action)?(n.log("handlers.actionKeys"),o.call(t.action,t)):a&&a.hasAction(t.action)?a.call(t.action,t.data):void n.log("Unknown action "+t.action);n.log("user in ignore list")}else n.log("another user");else n.error("same user")}),await t.ready(),{sendRawAll:c,sendRawTo:l,registerHandler:s}},on:i,registerHandler:s,sendRawAll:c,sendRawTo:l,dispose:()=>{for(const e of o.actionKeys())o.set(e,[]);s(null)}}}},311(e,n,t){t.d(n,{cx:()=>a,y8:()=>s});var r=t(130),o=t(233);function i(e,n,t){const r=[];for(const o of e){if(!t.hasAction(o))continue;const e=t.getAction(o),i=n.on(o,e),a=()=>n.unsubscribe(o,i);r.push(a)}(0,o.v)(r.length>0,"Bad glue");return()=>{for(const e of r)e()}}function a(e,n,t,o,a){const s=Object.keys(n),c=(l=n,{hasAction:e=>Object.hasOwn(l,e),getAction:e=>l[e]});var l;const u=function(e,n,t,o,i){const a=(0,r.A)(n),s=e.on("message",e=>{if(i){if(t.log("Received message",e),e.from===i)return void t.error("same user");if(e.to!==i&&"all"!==e.to)return void t.log("another user");if(e.ignore&&Array.isArray(e.ignore)&&e.ignore.includes(i))return void t.log("user in ignore list")}a.hasAction(e.action)?o?a.call(e.action,e.data):a.call(e.action,e):t.log("not my action "+e.action)}),{on:c,getActions:l,unsubscribe:u}=a;return{on:c,getActions:l,unsubscribe:u,unsubscribeAll:()=>e.unsubscribe("message",s)}}(e,s,t,o,a),d=i(s,u,c);return()=>{d(),u.unsubscribeAll()}}function s(e,n,t,r,o,s,c,l,u){const d=function(e,n,t,r){return{hasAction:()=>!0,getAction:o=>i=>{!r||r(i)?e.send(o,i,n):t.log("ignore",i)}}}(t,l,o,u),f=i(n,e,d),g=a(t,r,o,s,c);return()=>{f(),g()}}},268(e,n,t){t.d(n,{A:()=>s});var r=t(788),o=t(366);async function i(e,n,i,a){const s=r.A.getWebSocketUrl(a,i);if(!s)throw new Error("Bad socket url");const c=(0,(await t.e(749).then(t.bind(t,749))).default)(e,s,n);return await Promise.race([c.ready(),(0,o.h)(1e3)]),c}async function a(e,n,r,o){const i=(await t.e(281).then(t.bind(t,281))).default;return e===n?i.makeSupaChanServer(e,r,o):i.makeSupaChanClient(e,r,o,n)}async function s(e,n,r,o,s){switch(o.channelType){case"socket":return i(e,s,r,o);case"supa":return a(e,n,o,s);case"auto":return async function(e,n,t,r,o){try{return await i(e,o,t,r)}catch(t){return o.error(t),a(e,n,r,o)}}(e,n,r,o,s);case"autocs":return async function(e,n,r,o,a){try{return await i(e,a,r,o)}catch(r){return a.error(r),(await t.e(281).then(t.bind(t,281))).default.makeSupaChanClientOrServer(e,n,o,a)}}(e,n,r,o,s);case"fake":return(await t.e(877).then(t.bind(t,877))).default(e,s);case"none":return null}}},489(e,n,t){function r(e){let n=Promise.resolve();return{add:t=>new Promise((r,o)=>{if("function"!=typeof t)return e?.log("Not function! "+t),void o(new Error("Not function!"));n=n.then(t).then(r).catch(n=>{e?.error(n),o(n)})})}}t.d(n,{A:()=>r})},788(e,n,t){t.d(n,{A:()=>o});var r=t(840);const o={getMyId:function(e,n,t){const o=n.idNameInStorage||"my-id",i=e.sessionStorage.getItem(o);if(i)return i;const a=n.idNameLen||6,s=r.A.makeId(a,t);return e.sessionStorage.setItem(o,s),s},setupMedia:function(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia({audio:!0,video:!0})},getHostUrl:function(e,n){return e.sh?e.sh:n.origin+n.pathname},getWebSocketUrl:function(e,n){return e.wh?e.wh:"https:"!==n.protocol?"ws://"+n.hostname+":"+e.wsPort:void 0}}},840(e,n,t){function r(e,n){return function(e,n,t){const r=e+t()*(n-e);return Math.floor(r)}(0,e,n)}t.d(n,{A:()=>o});const o={makeId:function(e,n){let t="";const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)t+=r.charAt(Math.floor(62*n()));return t},randomEl:function(e,n=Math.random){return e[r(e.length,n)]}}},510(e,n,t){t.d(n,{A:()=>r});const r=function(e){return{message:e.onMessage}}},189(e,n,t){t.d(n,{A:()=>a});function r(e){switch(e){case 5:return"S";case 2:return"O";case 0:return" "}return""}function o(e){return Array.from({length:e}).fill(0)}function i(e){const n=[5,2],t=[-1,-1,...e,-1,-1],o=t.length-4,a=e=>e>=0&&e<o,s=e=>{for(let n=e+2;n<e+5;++n){if(5===t[n-2]&&2===t[n-1]&&5===t[n])return 3}for(let e=0;e<o;e++)if(0===t[e+2])return 1;return 2},c=e=>0===t[2+e],l=e=>a(e)&&c(e),u=()=>t.slice(2,-2);return{size:()=>o,setSafe:(e,n)=>l(n)?(((e,n)=>{t[2+n]=function(e){switch(e){case"S":case"s":return 5;case"O":case"o":return 2;case" ":return 0;case"":return-1}return-1}(e)})(e,n),s(n)):-1,setSafeByIndex:(e,r,o=!1)=>{if(!l(r))return-1;if(e<0||e>=n.length)return-1;const i=t[2+r];t[2+r]=n[e];const a=s(r);return o&&(t[2+r]=i),a},getCharSafe:e=>a(e)?(e=>r(t[2+e]))(e):"",canSet:l,clone:()=>i(e),movesLeft:()=>t.reduce((e,n)=>e+(0===n),0),toArr:u,asString:()=>u().map(r).join(""),isEmpty:c,inBounds:a,checkWinning:s}}const a={defaultField:function(e){return i(o(e))},field:i,init:o,IMPOSSIBLE_MOVE:-1,NORMAL_MOVE:1,WINNING_MOVE:3,DRAW_MOVE:2}},334(e,n,t){t.r(n),t.d(n,{default:()=>s});var r=t(268),o=t(788),i=t(530),a=t(789);async function s(e,n,t,s){const c=o.A.getMyId(e,t,Math.random),l=(0,i.A)(n,t),u=await(0,r.A)(c,null,e.location,t,l),d=await(0,a.a)(n,t,c,u,e,l);return(0,a.E)(e,n,t,s,l,u,d.data,c)}},789(e,n,t){t.d(n,{E:()=>g,a:()=>f});var r=t(373),o=t(510),i=t(975),a=t(401),s=t(311),c=t(366),l=t(530),u=t(233);const d=e=>!(!e||null!==e.playerId&&e.playerId!==e.clientId);async function f(e,n,t,r,o,i){if(!r)throw i.log("No chan client"),new Error("No chan client");const s=(0,l.A)(e,n,1,null,"clientRtcBroadConn1"),d=(0,a.A)(t,s,r),f=Promise.withResolvers();d.on("gameinit",e=>{f.resolve(e)}),d.on("reconnect",e=>{(0,u.v)(e.data.serverId===e.from,`Different server ${e}`);const n=new URL(o.location.href);n.searchParams.delete("z"),n.searchParams.set("serverId",e.data.serverId),o.location.replace(n.toString())});(await d.connect()).sendRawAll("join",{}),i.log("joined. Wait for gameinit");return await Promise.race([f.promise,(0,c.h)(5e3)])}function g(e,n,t,a,c,l,u,f){c.log("Start game",u),(0,i.b)(n);const g=r.A.presenterFunc(u.presenter,t),A=a(e,n,t,g),m=(0,o.A)(A);return(0,s.y8)(A,Object.keys(m),l,m,c,!0,f,u.serverId,d),t.fastRestart&&A.on("winclosed",()=>{g.nextRound(),A.redraw()}),A}},373(e,n,t){t.d(n,{A:()=>l});var r=t(189),o=t(130),i=t(489);function a(e,n,t,r,o){const i=t;let a="";return o>=0&&o<r.length&&(a=r[o]),{isLastMove:e,isActive:n,text:i,color:a}}function s(e){return{clientUserIdx:e.colorOrder.indexOf(e.color),currentUserIdx:0,playersSize:e.playerLimit,activeCellIndex:-1,activeDigitIndex:-1,lastMove:-1,gameover:!0,round:0,moveCount:0,fieldArr:r.A.init(e.size),movesIdx:Array.from({length:e.size}).fill(-1)}}function c({currentUserIdx:e,clientUserIdx:n,playersSize:t,activeCellIndex:s,activeDigitIndex:c,lastMove:l,gameover:u,round:d,moveCount:f,fieldArr:g,movesIdx:A},m){let v=r.A.field(g);const h=(0,i.A)(console),y=(0,o.A)(["moveEnd","nextPlayer","gameover"]),I=y.on;const w=()=>{e=(e+1)%t},p=async function(t,o,i){if(!((e,n,t,r)=>!(n<0||n>=2)&&t===r&&v.canSet(e))(t,o,i,e))return{res:r.A.IMPOSSIBLE_MOVE,position:-1,digit:-1,playerId:e,clientId:i};const a=v.setSafeByIndex(o,t);if(a===r.A.IMPOSSIBLE_MOVE)return{res:a,position:-1,digit:-1,playerId:e,clientId:i};s=-1,c=-1,A[t]=i,l=t,++f;const d=e,g=n;return await y.call("moveEnd",{res:a,position:t,digit:o,playerId:d,clientId:g,moveCount:f}),a===r.A.NORMAL_MOVE&&(w(),await y.call("nextPlayer",{res:a,position:t,digit:o,playerId:d,clientId:g,moveCount:f})),a!==r.A.WINNING_MOVE&&a!==r.A.DRAW_MOVE||(u=!0,await y.call("gameover",{res:a,position:t,digit:o,playerId:d,clientId:g,moveCount:f})),{res:a,position:t,digit:o,playerId:d,clientId:g}},M=(e,n,t)=>h.add(()=>p(e,n,t)),S=v.size,b=()=>m.colorOrder[e],O=()=>{f=0,u=!1,s=-1,c=-1,l=-1,g=r.A.init(S()),A=Array.from({length:S()}).fill(-1),e=d%t,v=r.A.field(g)};return{on:I,size:S,tryMove:()=>M(s,c,e),setMoveAsync:M,enum1:()=>function*(){for(let e=0;e<v.size();++e)yield[e,a(l===e,s===e,v.getCharSafe(e),m.colorOrder,A[e])]}(),setActivePosition:function(t){n!==e||u||(s=v.canSet(t)?t:-1)},setActiveDigitIndex:function(t){n!==e||u||(c=t)},currentColor:b,isActiveDigit:e=>e===c,endMessage:t=>t===r.A.DRAW_MOVE?"Draw":e!==n?"You lose":"You win",endMessage2:e=>e===r.A.DRAW_MOVE?"Draw":b()+" player win",toJson:n=>({currentUserIdx:e,clientUserIdx:n,playersSize:t,activeCellIndex:s,activeDigitIndex:c,lastMove:l,gameover:u,fieldArr:v.toArr(),movesIdx:A,moveCount:f}),isGameOver:()=>u,isMyMove:()=>!u&&e===n,calcLastMoveRes:()=>{if(l<0)return r.A.IMPOSSIBLE_MOVE;return v.checkWinning(l)},getCurrentIndex:()=>e,setClientIndex:e=>{n=e},getClientIndex:()=>n,getPlayersSize:()=>t,setMyTurn:()=>{e=n},nextRound:()=>{++d,O()},resetRound:O}}const l={presenterFunc:c,defaultPresenter:s,presenterFuncDefault:function(e){return c(s(e),e)}}},975(e,n,t){function r(e){e.querySelector(".game").classList.remove("hidden");e.querySelector(".lobby").classList.add("hidden");const n=e.querySelector(".menu");n.querySelector(".control-panel")?.classList.add("absolute");e.querySelector(".log").innerHTML=""}t.d(n,{b:()=>r})}}]);