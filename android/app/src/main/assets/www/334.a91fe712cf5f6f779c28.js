"use strict";(self.webpackChunksosgame=self.webpackChunksosgame||[]).push([[334],{510:(e,n,r)=>{r.d(n,{A:()=>o});const o=function(e){return{message:e.onMessage}}},940:(e,n,r)=>{r.d(n,{A:()=>i});var o=r(746);function t(){}function i(e,n){const r=(0,o.A)(["close","disconnect","error","join","gameinit","reconnect"]);let i={},s=null;return{connect:function(c){return new Promise(((a,l)=>{c||l("Can't determine ws address");const d=function(e,n,r){const i=(0,o.A)(["error","open","message","beforeclose","close"]),s=new WebSocket(n);function c(e){r.log("Websocket message received: "+e);const n=JSON.parse(e);return i.call("message",n)}return s.onopen=function(){return i.call("open",e)},s.onclose=function(n){return r.log("Websocket closed "+n.code+" "+n.reason),i.call("close",e)},s.onmessage=function(e){if(e.data instanceof Blob){const n=new FileReader;return n.onload=()=>c(n.result),n.readAsText(e.data)}return c(e.data)},s.onerror=function(n){return r.error(n),i.call("error",e)},{on:(e,n)=>i.on(e,n),send:(n,o,t,i)=>{const c={from:e,to:t,action:n,data:o,ignore:i};return r.log("Sending ["+e+"] to ["+t+"]: "+JSON.stringify(o)),s.send(JSON.stringify(c))},close:async()=>(await i.call("beforeclose",e),s.onerror=t,s.close())}}(e,c,n);d.on("message",(function(o){if(o.from!==e)if(o.to===e||"all"==o.to){if(!(o.ignore&&Array.isArray(o.ignore)&&o.ignore.includes(e)))return r.actionKeys().includes(o.action)?(n.log("handlers.actionKeys"),r.call(o.action,o)):Object.keys(i).includes(o.action)?(n.log("callCurrentHandler"),function(e,r){const o=i[e];"function"==typeof o?null!=s?s.add((()=>o(r.data,r.from))):n.log("No queue"):n.log("Not function")}(o.action,o)):void n.log("Unknown action "+o.action);n.log("user in ignore list")}else n.log("another user");else n.error("same user")}));const u=(e,r,o)=>(n.log(r),d.send(e,r,"all",o)),g=(e,n,r)=>d.send(e,n,r);d.on("open",(()=>a({sendRawAll:u,sendRawTo:g})))}))},on:function(e,n){return r.on(e,n)},getWebSocketUrl:function(e,n){return e.wh?e.wh:"https:"===n.protocol?null:"ws://"+n.hostname+":"+e.wsPort},registerHandler:function(e,n){s=n,i=e}}}},334:(e,n,r)=>{r.r(n),r.d(n,{default:()=>l});var o=r(267),t=r(940),i=r(373),s=r(510),c=r(233),a=r(379);function l(e,n,r,l){return new Promise(((d,u)=>{const g=o.A.getMyId(e,r,Math.random),f=o.A.setupLogger(n,r),m=(0,t.A)(g,f),A=(0,c.A)(f);m.connect(m.getWebSocketUrl(r,e.location)).then((o=>{f.log("connected"),m.on("gameinit",(t=>{f.log("gameinit",t);const c=i.A.presenterFunc(t.data.presenter,r),a=l(e,n,r,c),u=(0,s.A)(a);m.registerHandler(u,A),function(e,n,r,o){for(const t of e.actionKeys())e.on(t,(e=>{!e||null!==e.playerId&&e.playerId!==o.joinedInd?r.log("ignore"):n.sendRawTo(t,e,o.serverId)}))}(a,o,f,t.data),d(a)})),m.on("reconnect",(n=>{(0,a.vA)(n.data.serverId===n.from,`Different server ${n}`),e.location.reload()})),o.sendRawAll("join")})).catch((e=>{f.error(e),u(e)}))}))}},267:(e,n,r)=>{r.d(n,{A:()=>i});var o=r(379);const t={makeId:function(e,n){let r="";const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<e;t++)r+=o.charAt(Math.floor(62*n()));return r}};const i={setupLogger:function(e,n){return function(e,n){return{log:r=>{if(n.networkDebug)return(0,o.Rm)(r,e)},error:n=>{if(e)return(0,o.z3)(n,e)}}}(n.logger?e.querySelector(n.logger):null,n)},getMyId:function(e,n,r){const o=e.sessionStorage.getItem(n.idNameInStorage);if(o)return o;const i=t.makeId(n.idNameLen,r);e.sessionStorage.setItem(n.idNameInStorage,i)},setupMedia:function(){if(navigator.mediaDevices)return navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}}},373:(e,n,r)=>{r.d(n,{A:()=>a});var o=r(189),t=r(746);function i(e,n,r,o,t){let i=r,s="";return t>=0&&t<o.length&&(s=o[t]),{isLastMove:e,isActive:n,text:i,color:s}}function s(e){return{clientUserIdx:e.colorOrder.indexOf(e.color),currentUserIdx:e.colorOrder.indexOf(e.color),playersSize:e.colorOrder.length,activeCellIndex:-1,activeDigitIndex:-1,lastMove:-1,gameover:!1,gamestarted:!1,round:0,fieldArr:o.A.init(e.size),movesIdx:Array(e.size).fill(-1)}}function c({currentUserIdx:e,clientUserIdx:n,playersSize:r,activeCellIndex:s,activeDigitIndex:c,lastMove:a,gameover:l,gamestarted:d,round:u,fieldArr:g,movesIdx:f},m){let A=o.A.field(g);const v=(0,t.A)(["firstmove","gameover"]);const I=function(t,i,u){if(!((e,n,r,o)=>!(n<0||n>=2)&&r==o&&A.canSet(e))(t,i,u,e))return{res:o.A.IMPOSSIBLE_MOVE,position:-1,digit:-1,playerId:e,clientId:u};const g=A.setSafeByIndex(i,t);if(g===o.A.IMPOSSIBLE_MOVE)return{res:g,position:-1,digit:-1,playerId:e,clientId:u};s=-1,c=-1,d||v.call("firstmove",{}),d=!0,f[t]=u,a=t;const I=e,p=n;return g===o.A.NORMAL_MOVE&&(e=(e+1)%r,"hotseat"===m.mode&&(n=e)),g!==o.A.WINNING_MOVE&&g!==o.A.DRAW_MOVE||(l=!0,v.call("gameover",g)),{res:g,position:t,digit:i,playerId:I,clientId:p}},p=A.size,M=()=>m.colorOrder[e];return{on:function(e,n){return v.on(e,n)},size:p,tryMove:function(){return I(s,c,e)},setMove:I,enum1:()=>function*(){for(let e=0;e<A.size();++e)yield[e,i(a===e,s===e,A.getCharSafe(e),m.colorOrder,f[e])]}(),setActivePosition:function(r){n!==e||l||(s=A.canSet(r)?r:-1)},setActiveDigitIndex:function(r){n!==e||l||(c=r)},currentColor:M,getActiveDigitIndex:()=>c,endMessage:r=>r===o.A.DRAW_MOVE?"Draw":e!==n?"You lose":"You win",endMessage2:e=>e===o.A.DRAW_MOVE?"Draw":M()+" player win",toJson:n=>({currentUserIdx:e,clientUserIdx:n,playersSize:r,activeCellIndex:s,activeDigitIndex:c,lastMove:a,gameover:l,fieldArr:A.toArr(),movesIdx:f}),isGameOver:()=>l,isMyMove:()=>!l&&e===n,calcLastMoveRes:()=>{if(a<0)return o.A.IMPOSSIBLE_MOVE;return A.checkWinning(a)},nextRound:()=>{++u,d=!1,l=!1,s=-1,c=-1,a=-1,l=!1,d=!1,g=o.A.init(m.size),f=Array(m.size).fill(-1),e=(n+u)%r,A=o.A.field(g)}}}const a={presenterFunc:c,defaultPresenter:s,presenterFuncDefault:function(e){return c(s(e),e)}}},233:(e,n,r)=>{function o(e){let n=Promise.resolve();return{add:r=>new Promise(((o,t)=>{n=n.then(r).then(o).catch((n=>{e.log(n),t(n)}))}))}}r.d(n,{A:()=>o})}}]);