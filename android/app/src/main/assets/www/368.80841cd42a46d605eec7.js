"use strict";(self.webpackChunksosgame=self.webpackChunksosgame||[]).push([[368],{782(e,n,t){t.d(n,{A:()=>r});var o=t(233);function r(e,n=0,t){const r=[];for(const[n]of Object.entries(e))r.push(n);let s=r.length;const a=n=>{const t=e[n];return(0,o.v)(t,`No id ${n} in clients`),t},c=e=>{const n=r[e];return(0,o.v)(n,"Bad Index"),a(n)},i=(e,n)=>{const t=e.index,o=r[t];r[e.index]=r[n.index],e.index=n.index,r[n.index]=o,n.index=t},l=e=>(e+r.length)%r.length;return{addClient:(n,t)=>{const a=e[n];a?a.name=t:(e[n]={index:s,name:t},r.push(n),++s),(0,o.v)(s===r.length)},remove:n=>{const t=e[n];--s;const a=r[s];r[t.index]=a,r.pop();e[a].index=t.index,e[n]=void 0,(0,o.v)(s===r.length)},swapInd:(e,n)=>{const t=c(e),o=c(n);i(t,o)},swapById:(e,n)=>{const t=a(e),o=a(n);i(t,o)},indById:e=>l(a(e).index+n),idByInd:e=>r[l(e-n)],isAllIgnored:e=>{const n=new Set(r),o=new Set(e);o.add(t);return 0===n.difference(o).size},size:()=>r.length}}},421(e,n,t){t.d(n,{Ef:()=>f,wZ:()=>g});var o=t(782),r=t(530),s=t(130);var a=t(788),c=t(301),i=t(510),l=t(975),d=t(373);function u(e,n,t,a,c,d,u){const f=(0,o.A)({},t.getClientIndex(),a);f.addClient(a,a);const g=(0,r.A)(e,c,10);n.on("winclosed",()=>(t.nextRound(),n.redraw(),function(e,n){const t={serverId:n};return e.sendRawAll("reconnect",t)}(u,a))),u.on("join",o=>{g.log("join",o),f.addClient(o.from,o.from);const r=f.indById(o.from),s=f.indById(a);f.size()===c.playerLimit&&t.isGameOver()&&(t.resetRound(),(0,l.b)(e));const i=t.toJson(r),u={serverId:a,joinedInd:r,serverInd:s,presenter:i};return d.sendRawTo("gameinit",u,o.from),n.redraw()});const m=(0,i.A)(n),w=function(e){const n=Object.keys(e),t=(0,s.A)(n);for(const[n,o]of Object.entries(e))t.on(n,o);return t}(m);u.registerHandler(w),function(e,n,t,o,r){for(const s of r)o.log("register "+s),e.on(s,e=>{let r;if(e&&void 0!==e.playerId&&(r=[t.idByInd(e.playerId)],t.isAllIgnored(r)))o.log("ignore "+s);else{o.log("send "+s);try{n.sendRawAll(s,e,r)}catch(e){o.error(e)}o.log("after call "+s)}})}(n,u,f,g,Object.keys(m))}function f(e,n,t,o,r,s,a){const c=d.A.presenterFuncDefault(t),i=o(e,n,t,c);return u(n,i,c,a,t,s,r),i}function g(e,n,t,o){const r=a.A.getHostUrl(t,e.location),s=new URL(r);o&&s.searchParams.set("serverId",o);return(0,c.$i)(s.toString(),e,n,t,{source:"./images/sos.png",width:"10%",height:"20%",x:"center",y:"center"})}},368(e,n,t){t.r(n),t.d(n,{default:()=>y});var o=t(421),r=t(530),s=t(369),a=t(788),c=t(268),i=t(130),l=t(109),d=t(366);function u(e,n){const t=(0,i.A)(["error","open","message","beforeclose","close"]);let o=!1,r=null,s=null,a=Promise.withResolvers(),c=Promise.withResolvers().promise,u=Promise.withResolvers(),f=null,g=0,m=Promise.withResolvers();let w=[];const h=async()=>{w=[],await(a=Promise.withResolvers(),u=Promise.withResolvers(),m=Promise.withResolvers(),c=y(),c),n.log("Offer reseted",f.iceConnectionState),await A(),n.log("Ans reseted",r.label,f.iceConnectionState)};function v(){const t={add:e=>{w.push(e)},done:()=>{a.resolve(w)},resetCands:h};f=(0,l.q)(e,n,t),r=f.createDataChannel("gamechannel"+e),n.log("datachanid "+r.id,r.label),p(!1)}async function y(){return await f.setLocalDescription(),()=>f.localDescription}function p(s){r.onmessage=function(e){n.log("data get "+e.data);const o=JSON.parse(e.data);return t.call("message",o)},r.onopen=function(){n.log("------ DATACHANNEL OPENED ------");const s=f.sctp.maxMessageSize;return n.log("datachanid "+r.id,r.label,s),o=!0,m.resolve(e),t.call("open",e)},r.onclose=function(s){n.error("------ DC closed! ------",r.readyState,s),o=!1;const a=t.call("close",e);return++g,r=f.createDataChannel("chanReconnect"+g+e),p(!0),f.restartIce(),h(),a},r.onerror=function(e){n.error("DC ERROR!!!",r.readyState,e)}}async function A(){n.log("before before set");const e=await u.promise;n.log("before set",e),await async function(e){s=e.id;const t={type:"answer",sdp:e.sdp};await f.setRemoteDescription(t),e.cands&&(n.log("cands"),await(0,l.E)(e.cands,f)),n.log("answer",e)}(e),n.log("after set",e)}return{on:t.on,send:(t,a,c,i)=>{if(!o)return n.error("Not connected"),!1;if(s||n.error("No client"),void 0===c&&(c=s),"all"!==c&&c!==s&&n.error("Bad client",c,s),!r)return n.error("Not data channel"),!1;const l={from:e,to:c,action:t,data:a,ignore:i};n.log("before send",t,r.readyState,r.label,r.id),n.log(t+" Sending1 ["+e+"] to ["+c+"]: "+JSON.stringify(a));const d=JSON.stringify(l);return r.send(d)},close:async s=>{s??="close chan",m.reject(s),await t.call("beforeclose",e),o&&(o=!1,r&&(n.log("Try to close"),r.close()))},ready:()=>m.promise,getDataToSend:async function(){return v(),c=y(),await async function(){const t=(0,d.h)(2e3),o=await c,r=await Promise.race([a.promise,t]).catch(()=>[]),s=o();return n.log("cands",r.length),{offer:s,id:e}}()},getOtherId:()=>s,resolveExternal:e=>u.resolve(e),processAns:A}}var f=t(301),g=t(192);var m=t(311);function w(e,n,t){const o=Promise.withResolvers(),r=n.querySelector(".qr-btn");return r.classList.remove("hidden"),r.addEventListener("click",async()=>{let r=await async function(e,n,t){try{const o=n.querySelector(".video-barcode");if(!o||o.querySelector("video")||!("BarcodeDetector"in e))return;const r=new BarcodeDetector({formats:["qr_code"]}),s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),a=n.createElement("video");a.srcObject=s,o.append(a),await a.play();const c=Promise.withResolvers(),i=async e=>{const n=await r.detect(a);if(n.length>0){t.log(n);const o=s.getTracks();for(const e of o)e.stop();a.remove(),e.resolve(n[0].rawValue)}else t.error("No codes found"),await(0,d.c)(100),requestAnimationFrame(()=>{i(e)});return e};return i(c),c.promise}catch(e){t.error("Error accessing camera or detecting barcodes:",e)}}(e,n,t);if(t.log("codes1",r),!r){const e=prompt("Get code from qr");if(null==e)return void o.reject();r=e}const s=g.A.uncrush(r);o.resolve(JSON.parse(s))}),o.promise}async function h(e,n,t,o){const s=(0,r.A)(t,o,2,null,"mainServer"),i=(0,r.A)(t,o,1),l=Promise.race([(0,c.A)(e,e,n.location,o,i),(0,d.h)(5e3)]).catch(()=>null),h=u(e,(0,r.A)(t,o,3)),v=h.getDataToSend();!async function(e,n,t,o,r){const s=await n;let a=null;const c={offer_and_cand:n=>(o.log("offerCand",n),e.resolveExternal(n.data),Promise.race([e.ready(),(0,d.h)(2e4)]).catch(()=>{null!=a&&s.send("stop_waiting",{},a),e.close("timeout7")})),join:async e=>{if(o.log("onJoin",e),a??=e.from,a===e.from){const e=await t;s.send("offer_and_cand",e,a)}}};(0,m.cx)(s,c,o,!1,r)}(h,l,v,i,e);let y=null;try{const e=function(e,n,t,o,r){const s=a.A.getHostUrl(t,e.location);let c=s;if(o){const n=JSON.stringify(o),t=g.A.crush(n);c=s+"?z="+e.encodeURIComponent(t)}else r.log("No data",o);return(0,f.$i)(c,e,n,t)}(n,t,o,await v,s);w(n,t,s).then(e=>{s.log("decoded",e),h.resolveExternal(e)}).catch(e=>{s.error(e)}),await h.processAns(),s.log("Ans setted"),await h.ready(),s.log("Chan ready"),(0,f.k6)(e),y=h}catch(e){s.error(e);const n=await l;n&&await n.ready(),y=n}return y}var v=t(401);async function y(e,n,t,c){const i=(0,r.A)(n,t,1);(0,s.A)(n,t);const l=a.A.getMyId(e,t,Math.random);n.querySelector(".game").classList.add("hidden");const d=(0,o.wZ)(e,n,t,l),u=await h(l,e,n,t);(0,f.k6)(d);const g=(0,v.A)(l,i,u),m=(0,o.Ef)(e,n,t,c,g,g,l);return await g.connect(),m}}}]);