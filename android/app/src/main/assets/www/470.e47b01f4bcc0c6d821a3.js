"use strict";(self.webpackChunksosgame=self.webpackChunksosgame||[]).push([[470],{789(e,n,t){t.d(n,{E:()=>g,a:()=>f});var r=t(373),a=t(510),o=t(975),s=t(401),c=t(311),i=t(366),l=t(530),u=t(233);const d=e=>!(!e||null!==e.playerId&&e.playerId!==e.clientId);async function f(e,n,t,r,a,o){if(!r)throw o.log("No chan client"),new Error("No chan client");const c=(0,l.A)(e,n,1,null,"clientRtcBroadConn1"),d=(0,s.A)(t,c,r),f=Promise.withResolvers();d.on("gameinit",e=>{f.resolve(e)}),d.on("reconnect",e=>{(0,u.v)(e.data.serverId===e.from,`Different server ${e}`);const n=new URL(a.location.href);n.searchParams.delete("z"),n.searchParams.set("serverId",e.data.serverId),a.location.replace(n.toString())});(await d.connect()).sendRawAll("join",{}),o.log("joined. Wait for gameinit");return await Promise.race([f.promise,(0,i.h)(5e3)])}function g(e,n,t,s,i,l,u,f){i.log("Start game",u),(0,o.b)(n);const g=r.A.presenterFunc(u.presenter,t),m=s(e,n,t,g),w=(0,a.A)(m);return(0,c.y8)(m,Object.keys(w),l,w,i,!0,f,u.serverId,d),t.fastRestart&&m.on("winclosed",()=>{g.nextRound(),m.redraw()}),m}},470(e,n,t){t.r(n),t.d(n,{default:()=>y});var r=t(789),a=t(369),o=t(530),s=t(788),c=t(130),i=t(109),l=t(366);function u(e,n){const t=(0,c.A)(["error","open","message","beforeclose","close"]);let r=!1,a=null,o=null;const s=[],u=Promise.withResolvers(),d=Promise.withResolvers();async function f(o){const c={add:e=>{s.push(e)},done:()=>{u.resolve(s)},resetCands:()=>{n.error("Try to reset")}},l=(0,i.q)(e,n,c);l.ondatachannel=o=>{a=o.channel,function(a){a.onmessage=function(e){n.log("data get "+e.data);const r=JSON.parse(e.data);return t.call("message",r)},a.onopen=function(){return n.log("------ DATACHANNEL OPENED ------"),r=!0,d.resolve(e),t.call("open",e)},a.onclose=function(){return n.log("------ DC closed! ------"),r=!1,t.call("close",e)},a.onerror=function(){n.error("DC ERROR!!!")}}(o.channel)};const f=o.offer;return await l.setRemoteDescription(f),o.cands&&await(0,i.E)(o.cands,l),await l.setLocalDescription(),n.log("set answer",JSON.stringify(l.localDescription)),()=>l.localDescription}const{on:g,unsubscribe:m,unsubscribeAll:w}=t;return{on:g,unsubscribe:m,unsubscribeAll:w,send:(t,s)=>{if(!r)return!1;if(!a)return!1;const c={from:e,to:o,action:t,data:s};n.log("Sending ["+e+"] to ["+o+"]: "+JSON.stringify(s));const i=JSON.stringify(c);return a.send(i)},close:async()=>{d.reject("close"),await t.call("beforeclose",e),r&&(r=!1,a&&a.close())},ready:()=>d.promise,getClientData:async function(t){const r=await t;o=r.id,n.log("get offer promise",r);const a=await f(r),s=await Promise.race([u.promise,(0,l.c)(2e3)]),c=a(),i={sdp:c.sdp,id:e};return n.log("send reply",i,c,s),i},getOtherId:()=>o}}var d=t(268),f=t(301),g=t(192),m=t(311);function w(e,n){const t=e.location.search,r=new e.URLSearchParams(t).get("z");if(!r)return;const a=g.A.uncrush(r),o=JSON.parse(a),s=new URL(e.location.href);s.searchParams.delete("z"),history.replaceState({},document.title,s.href),n.resolve(o)}async function h(e,n,t,r){const a=(0,o.A)(t,r,2,null,"mainLog"),s=Promise.withResolvers();w(n,s);let c=await Promise.race([s.promise,Promise.resolve(null)]).then(e=>e?.id);c||(c=r.serverId),a.log("maybe server "+c);const i=(0,o.A)(t,r,1),h=Promise.race([(0,d.A)(e,c,n.location,r,i),(0,l.h)(5e3)]).catch(()=>null),y=(0,o.A)(t,r,3),p=u(e,y),v=(0,o.A)(t,r,1),A=async function(e,n,t,r,a){r.log("client connect");const o=await n;if(!o)return r.log("No chan"),t.reject("No chan"),()=>{};const s={gameinit:()=>{t.reject("bad server")},offer_and_cand:e=>{t.resolve(e)},stop_waiting:()=>{e.close()}},c=(0,m.cx)(o,s,r,!0,a);return await o.ready(),o.send("join",{},"all"),c}(p,h,s,y,e),b=Promise.race([s.promise,(0,l.h)(5e3)]);let P=null;try{const e=await p.getClientData(b),a=function(e,n,t,r,a){const o=JSON.stringify(r),s=g.A.crush(o),c=(0,f.$i)(s,e,n,t);return a.log(c),c}(n,t,r,e,v);!async function(e,n,t){const r=await t;r&&(await r.ready(),r.send("offer_and_cand",e,n))}(e,p.getOtherId(),h),await p.ready(),(0,f.k6)(a),async function(e){const n=await e;n&&n.close()}(h),P=p}catch(e){a.error(e);const n=await h;n&&await n.ready(),P=n}finally{!async function(e){(await e)()}(A)}return P}async function y(e,n,t,c){(0,a.A)(n,t);n.querySelector(".game").classList.add("hidden");const i=(0,o.A)(n,t,2,null,"mainLog"),l=s.A.getMyId(e,t,Math.random),u=await h(l,e,n,t),d=await(0,r.a)(n,t,l,u,e,i);return(0,r.E)(e,n,t,c,i,u,d.data,l)}}}]);